<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>I Was Here</title>
  <meta name="description" content="IWasHere">
  <meta name="author" content="PabloNS">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link href="./leafletjs.css" rel="stylesheet" />
  <style>
    /* Asegurarse de que la página ocupe toda la altura */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Raleway', sans-serif;
      overflow-x: hidden; /* Evita desplazamiento horizontal */
    }

    .container {
      height: 100vh;  /* Ocupa toda la altura de la ventana */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Centrado de la fila (el mapa y el formulario) */
    .row {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 2rem;
    }

    /* Ajuste para el mapa */
    #map {
      width: 100%;    /* El mapa ocupa todo el ancho */
      height: 50vh;   /* El mapa ocupa el 50% de la altura de la ventana */
      max-width: 600px;
      border-radius: 10px;
    }

    /* Ajustar formulario */
    .form-container {
      width: 100%;
      max-width: 500px;
      padding: 1rem;
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      margin-top: 20px;
    }

    .input-group {
      width: 100%;
      margin-bottom: 10px;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      box-sizing: border-box;
    }

    .button-primary {
      width: 100%;
    }

    /* Ajuste para pantallas más pequeñas */
    @media (max-width: 768px) {
      #map {
        height: 40vh; /* En móviles, el mapa ocupa el 40% de la altura de la ventana */
      }

      .form-container {
        width: 100%;
        padding: 10px;
        max-width: 400px; /* Reduce el tamaño del formulario en pantallas pequeñas */
      }
    }

    /* Estilo para el mensaje de "Loading map..." */
    #loadingMap {
      font-size: 18px;
      color: #333;
      font-weight: bold;
    }

    /* Asegurarse de que los mensajes sean visibles */
    #noNotesMessage {
      font-size: 16px;
      color: red;
      margin-top: 20px;
      text-align: center;
      width: 100%;
    }
  </style>
</head>

<body>
<!-- Primary Page Layout -->
<div class="container">
  <!-- Mapa -->
  <div class="row">
    <div class="form-container">
      <div id="loadingMap">Loading map...</div> <!-- Mensaje mientras se carga el mapa -->
      <div id="map"></div>
    </div>
  </div>

  <!-- Formulario -->
  <div class="row">
    <div class="form-container">
      <label for="nickname">Nickname</label>
      <input type="text" id="nickname" name="nickname" class="u-full-width">
      <p id="resultNickname"></p>

      <label for="comment">Comment</label>
      <input type="text" id="comment" name="comment" class="u-full-width">

      <button class="button-primary u-full-width" id="createNoteButton" onclick="note()">Create Note</button>
      <p id="result"></p>

      <button class="button-primary u-full-width" id="getNotesButton" onclick="getNotes()">Get Near Me Notes</button>
      <p id="noNotesMessage"></p> <!-- Mensaje para no encontrar notas -->
    </div>
  </div>
</div>

<script src="leafletjs.js"></script>
<script>
    let mapOptions;
    let map;
    let layer;
    let markerGroup;

    function getLocation(position, data) {
      var location = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
      };

      // Configuración del mapa
      mapOptions = {
        center: [location.latitude, location.longitude],
        zoom: 10
      };

      if (map == undefined) {
        map = new L.map('map', mapOptions);
        layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        map.addLayer(layer);

        // Ocultar el mensaje de "Loading map..."
        document.getElementById('loadingMap').style.display = 'none';
      } else {
        map.removeLayer(markerGroup);
        map.panTo([location.latitude, location.longitude]);
      }

      markerGroup = L.layerGroup().addTo(map);

      var meIcon = L.icon({
        iconUrl: 'me.png',
        iconSize: [30, 30]
      });

      var markerLocation = L.marker([location.latitude, location.longitude], { icon: meIcon }).addTo(markerGroup);
      var text = "<b> Your location </b>";
      markerLocation.bindPopup(text);

      if (data) {
        for (const element of data.data) {
          var marker = L.marker([element.latitude, element.longitude]).addTo(markerGroup);
          var text = "<h2>" + element.userNickname + "</h2>" +
            "<br>" + element.comment.substring(0, 40) + "</br>" +
            "<br>" + element.comment.substring(40, 80) + "</br>" +
            "<br>" + element.comment.substring(80) + "</br>"
          marker.bindPopup(text);
        }
      }
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(getLocation);
    }

    // Función para cambiar el texto del botón a "Creating note..."
    function setLoadingState(buttonId, text) {
      const button = document.getElementById(buttonId);
      button.innerHTML = text;
      button.disabled = true;  // Desactivar el botón mientras se carga
    }

    // Función para restaurar el texto original del botón
    function resetButtonText(buttonId, originalText) {
      const button = document.getElementById(buttonId);
      button.innerHTML = originalText;
      button.disabled = false;  // Reactivar el botón
    }

    var result = document.getElementById("result");
    var resultNickname = document.getElementById("resultNickname");
    var noNotesMessage = document.getElementById("noNotesMessage");

    // Función para limpiar los mensajes de los botones
    function clearMessages() {
      result.innerHTML = "";
      resultNickname.innerHTML = "";
      noNotesMessage.innerHTML = "";
    }

    function note() {
      clearMessages();  // Limpiar mensajes al pulsar el botón "Create Note"
      setLoadingState('createNoteButton', 'Creating note...');  // Cambiar texto del botón a "Creating note..."

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(createNote);
      } else {
        result.innerHTML = "Geolocation is not supported by this browser.";
        resetButtonText('createNoteButton', 'Create Note');  // Restaurar texto del botón
      }
    }

    let nickname;

    async function requestCreateNote(json) {
      const fetchPromise = await fetch("https://iwashere.onrender.com/notes", {
        method: "post",
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: json
      });

      return await fetchPromise;
    }

    function createNote(position) {
      if (nickname == undefined) {
        nickname = document.getElementById("nickname").value;
      }
      var note = document.getElementById("comment").value;

      if (nickname.length < 5 || nickname.length > 20) {
        resultNickname.innerHTML = "Write your nickname between 5 and 20 characters"
        resultNickname.style.color = "red";
        resetButtonText('createNoteButton', 'Create Note');  // Restaurar texto del botón
      } else if (note.length < 20 || note.length > 100) {
        resultNickname.innerHTML = nickname;
        resultNickname.style.color = "black";
        result.innerHTML = "Write a note between 20 and 100 characters";
        result.style.color = "red";
        resetButtonText('createNoteButton', 'Create Note');  // Restaurar texto del botón
      } else {
        var data = {
          comment: note,
          userNickname: nickname,
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        var json = JSON.stringify(data);

        requestCreateNote(json).then(response => {
          if (response.status == 200) {
            result.innerHTML = "Your note was successfully created!";
            result.style.color = "green";

            resultNickname.innerHTML = nickname;
            resultNickname.style.color = "black";

            if (document.getElementById("nickname") != null) {
              document.getElementById("nickname").remove();
            }

            document.getElementById('comment').value = "";
          } else {
            result.innerHTML = "Wait 24 hours to create a new note";
            result.style.color = "red";
          }
          resetButtonText('createNoteButton', 'Create Note');  // Restaurar texto del botón
        });
      }
    }

    function getNotes() {
      clearMessages();  // Limpiar mensajes al pulsar el botón "Get Near Me Notes"
      setLoadingState('getNotesButton', 'Loading notes...');  // Cambiar texto del botón a "Loading notes..."

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(getNearMeNotes);
      } else {
        result.innerHTML = "Geolocation is not supported by this browser.";
        resetButtonText('getNotesButton', 'Get Near Me Notes');  // Restaurar texto del botón
      }
    }

    function getNearMeNotes(position) {
      var data = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
      };

      var json = JSON.stringify(data);

      const fetchPromise = fetch("https://iwashere.onrender.com/notes/nearMe", {
        method: "post",
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: json
      })

      fetchPromise.then(response => {
        return response.json();
      }).then(data => {
        if (data.data.length === 0) {
          noNotesMessage.innerHTML = "Sorry, no notes found.";
          noNotesMessage.style.color = "red";

          // Asegurarse de que el mensaje de "no notes" esté visible
          noNotesMessage.scrollIntoView({ behavior: "smooth", block: "center" });
        } else {
          getLocation(position, data);
        }
        resetButtonText('getNotesButton', 'Get Near Me Notes');  // Restaurar texto del botón
      });
    }
</script>
</body>

</html>
